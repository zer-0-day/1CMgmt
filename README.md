# 1CMgmt

PowerShell-модуль для установки, обновления и администрирования 1С:Предприятие.

**Описание**  
Модуль 1CMgmt предоставляет набор функций, упрощающих:

- Автоматическую установку и обновление платформы 1С и серверов под различные версии и порты;
- Управление несколькими инстансами (current, current25, current35 и т.п.);
- Архивацию журналов регистрации (ЖР);
- Автоматическое обновление через задачи планировщика (Auto-Upgrade);
- Интерактивные консольные меню для удобного управления всем функционалом.


> Интерфейсы и имена функций могут меняться. Ознакомьтесь с меню и статьями ниже для подробностей.

---

##  Оглавление

- [Что это и для кого](#что-это-и-для-кого)
- [Требования](#требования)
- [Установка и обновление модуля](#установка-и-обновление-модуля)
  - [Шаг 1. Откройте PowerShell от администратора](#шаг-1-откройте-powershell-от-администратора)
  - [Шаг 2. Разрешите запуск скриптов (Windows)](#шаг-2-разрешите-запуск-скриптов-windows)
  - [Шаг 3. Установите модуль](#шаг-3-установите-модуль)
  - [Шаг 4. Импортируйте модуль](#шаг-4-импортируйте-модуль)
  - [Обновление модуля](#обновление-модуля)
  - [Удаление модуля](#удаление-модуля)
- [Быстрый старт: самые частые задачи](#быстрый-старт-самые-частые-задачи)
  - [Чистая установка первого сервера 1С](#чистая-установка-первого-сервера-1с)
  - [Добавление второго/третьего сервера (другие порты)](#добавление-второготретьего-сервера-другие-порты)
  - [Установка/обновление платформы из локальной папки или сетевого пути](#установкаобновление-платформы-из-локальной-папки-или-сетевого-пути)
  - [Сжатие журналов регистрации (ЖР)](#сжатие-журналов-регистрации-жр)
  - [Автоматический апгрейд сервера через планировщик](#автоматический-апгрейд-сервера-чрез-планировщик)
  - [Меню управления и задачи планировщика](#меню-управления-и-задачи-планировщика)
- [Тонкости и полезные заметки](#тонкости-и-полезные-заметки)
- [Устранение неполадок (FAQ)](#устранение-неполадок-faq)
- [Справочник функций](#справочник-функций)

---

## Что это и для кого

**1CMgmt** — набор удобных PowerShell‑функций для установки/обновления сервера 1С, обслуживания журналов регистрации и автоматизации через планировщик.

---

## Требования

- **Windows PowerShell 5.1**.
- Права **администратора** при установке/настройке службы 1С и компонентов.
- Доступ к интернету для установки из **PowerShell Gallery**.

Документация по `Install-Module`, `Import-Module` и исполнению скриптов. 

---

## Установка и обновление модуля

### Шаг 1. Запустите PowerShell от администратора

- Найдите **Windows PowerShell** или **PowerShell 7** → **Запуск от имени администратора**.

### Шаг 2. Разрешите запуск скриптов (Windows)

Если политика запрещает скрипты, выполните (однократно):

```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

Подробнее об Execution Policy — в документации Microsoft. 

### Шаг 3. Установите модуль

```powershell
Install-Module -Name 1CMgmt -Scope CurrentUser -Force
```

`Install-Module` ставит модуль из PSGallery в одну из папок из `$env:PSModulePath`. 

### Шаг 4. Импортируйте модуль

```powershell
Import-Module 1CMgmt
```

`Import-Module` загружает модуль в **текущую** сессию PowerShell. Для автозагрузки в новых сессиях добавьте эту команду в профиль, либо полагайтесь на **implicit import** при первом вызове функции. 

### Обновление модуля

```powershell
Update-Module -Name 1CMgmt
# либо переустановить:
Install-Module -Name 1CMgmt -Force
```

### Удаление модуля

```powershell
Remove-Module 1CMgmt -ErrorAction SilentlyContinue
Uninstall-Module 1CMgmt
```

---

## Быстрый старт: самые частые задачи

### Чистая установка первого сервера 1С

Параметры `-PortPrefix`, `-Version` и `-SetupPath` не обязательны. Если они не указаны, будет использована последняя найденная версия и порты 15xx.

1. Подготовьте каталог дистрибутива, например `D:\1Cv8.adm\windows64full_8_3_xx_xxxx.rar`. Ожидается именно такой архив в формате RAR, внутри которого есть папка `Server\64`.
2. Запустите:
   ```powershell
   # Установка сервера по умолчанию (последняя версия, порты 15xx)
   Install-1CServer
   ```
   Устанавливает последнюю версию платформы из 1cv8.adm, создаёт службу «**1C:Enterprise 8.3 Server Agent Current**», пользователя `USR1CV8`, папку `srvinfo`, права и т.д.

   Также функцию можно запускать с параметрами:
   - `-PortPrefix` — задать префикс портов (например, 25 или 35 для второго/третьего сервера).
   - `-Version` — указать конкретную версию платформы (например, `'8.3.25.1546'`).
   - `-SetupPath` — путь к папке или сетевому каталогу с дистрибутивом, откуда ставить/обновлять платформу.

Примеры:

```powershell
# Установка сервера по умолчанию (последняя версия, порты 15xx)
Install-1CServer

# Базовая установка сервера (последняя версия из 1Cv8.adm)
Install-1CServer

# Установка второго сервера на портах 25xx
Install-1CServer -PortPrefix 25

# Установка сервера на конкретной версии
Install-1CServer -Version '8.3.25.1546'

# Установка сервера с указанием сетевого пути к дистрибутиву
Install-1CServer -SetupPath '\\server\distr\8.3.25.1546'

# Установка второго сервера (25xx) с конкретной версией из сетевой папки
Install-1CServer -PortPrefix 25 -Version '8.3.25.1546' -SetupPath '\\server\distr\8.3.25.1546'
```

> ⚠️ Если задан параметр `-Version`, но соответствующий архив (`windows64full_<версия>.rar`) не найден, установка прерывается и сервер не устанавливается.

### Добавление второго/третьего сервера (другие порты)

Параметры `-PortPrefix`, `-Version` и `-SetupPath` не обязательны. Если они не указаны, будет использована последняя найденная версия и порты 15xx.

Для параллельной работы нескольких серверов используйте **префикс портов**:

```powershell
# второй сервер: порты 25xx, каталог srvinfo25
Install-1CServer -PortPrefix 25

# третий сервер: порты 35xx, каталог srvinfo35
Install-1CServer -PortPrefix 35

# установка на конкретной версии платформы:
Install-1CServer -PortPrefix 35 -Version '8.3.25.1546'
```

# установка второго сервера с конкретной версией из сетевой папки:
Install-1CServer -PortPrefix 25 -SetupPath "\\server\data\technical\1СПлатформы\1Cv83\8.3.22.1704"

> Для префикса `15` создаётся служба `… Current`, для остальных — `… Current25`, `… Current35` и т.д.

### Установка/обновление платформы из локальной папки или сетевого пути

Команда поддерживает как локальные каталоги, так и UNC‑пути.  
Если указан сетевой путь, архив дистрибутива копируется в `C:\1Cv8.adm`, распаковывается в каталог `1Cv8.adm\<версия>\Server\64`, после чего установка выполняется из этого каталога. После успешной распаковки исходный архив удаляется.  
Возврат кода `3010` трактуется как «успех, требуется перезагрузка», а у `robocopy` коды `0–7` считаются «успешными».  

```powershell
# локальный путь
Install-1CPlatform -SetupPath 'D:\1Cv8.adm\8.3.25.1546'

# сетевой путь — сначала скопируется в кэш, затем установка
Install-1CPlatform -SetupPath '\\fileserver\1c\8.3.25.1546'
```

Примеры:

```powershell
# Установить платформу из локальной папки
Install-1CPlatform -SetupPath 'D:\1Cv8.adm\8.3.25.1546'

# Установить платформу из сетевого пути (UNC)
Install-1CPlatform -SetupPath '\\server\share\1Cv83\8.3.25.1546'

# Обновить сервер и платформу одной командой
Install-1CServer -SetupPath '\\server\distr\8.3.25.1546'
```

Аналогично можно передать `-SetupPath` в `Install-1CServer`, чтобы перед установкой сервера обновить/поставить платформу из сети.

### Сжатие журналов регистрации (ЖР)

```powershell
# По умолчанию: архивируем файлы старше 7 дней, ZIP старше 90 — удаляем
Compress-1Clogs

# Кастомные параметры
Compress-1Clogs -FileDays 14 -ArchiveDays 60
```

Примеры:

```powershell
# Архивировать логи с настройками по умолчанию
Compress-1Clogs

# Архивировать логи, оставляя только 14 дней, архивы хранить 60 дней
Compress-1Clogs -FileDays 14 -ArchiveDays 60
```

### Автоматический апгрейд сервера через планировщик

Для автоматизации обновлений можно создать задачи в Планировщике Windows.

Параметр `-SetupPath` не обязателен — если не указан, используется локальный каталог `1Cv8.adm`.

#### Особенности
- Поддерживается апгрейд **current** и дополнительных серверов (`Current25`, `Current35` и т.д.).
- Имена задач формируются автоматически:
  - `New-1CServerAutoUpgradeTask` — для current
  - `New-1CServerAutoUpgradeTask-25` — для Current25
  - `New-1CServerAutoUpgradeTask-35` — для Current35
- При передаче нескольких префиксов (`-PortPrefix 25,35`) создаются отдельные задачи для каждого.

#### Примеры CLI
```powershell
# Создать задачу для обновления current
New-1CServerAutoUpgradeTask -RunAsUser 'DOMAIN\svc-1c'

# Создать задачи для current25 и current35
New-1CServerAutoUpgradeTask -RunAsUser 'DOMAIN\svc-1c' -PortPrefix 25,35

# Указать сетевой путь и PowerShell 7
New-1CServerAutoUpgradeTask -RunAsUser 'DOMAIN\svc-1c' `
  -SetupPath '\\server\distr' -PortPrefix 25,35 -Shell PowerShell7
```

Дополнительные примеры:

```powershell
# Создать задачу для nightly-апгрейда current в 02:00
New-1CServerAutoUpgradeTask -RunAsUser 'DOMAIN\svc-1c' -At '02:00'

# Создать задачу с PowerShell 7
New-1CServerAutoUpgradeTask -RunAsUser 'DOMAIN\svc-1c' -Shell PowerShell7

# Создать задачи для current25 и current35 с SetupPath
New-1CServerAutoUpgradeTask -RunAsUser 'DOMAIN\svc-1c' -SetupPath '\\server\distr' -PortPrefix 25,35
```


#### Примеры через меню
```powershell
Invoke-1CTaskMenu
```
В меню можно выбрать:
- «Создать задачу автоапгрейда current»
- «Создать задачи автоапгрейда CurrentXX»

#### Примеры ручного апгрейда (без планировщика)

```powershell
# Обновить current до последней версии из 1Cv8.adm
Start-1CServerUpgrade

# Обновить current до версии из сетевого пути
Start-1CServerUpgrade -SetupPath '\\server\distr\8.3.25.1704'

# Обновить и перезапустить второй сервер (Current25)
Start-1CServerUpgrade -PortPrefix 25

# Обновить Current25 с указанием сетевого пути
Start-1CServerUpgrade -SetupPath '\\server\distr\8.3.25.1704' -PortPrefix 25
```

### Меню управления и задачи планировщика

```powershell
# Главное меню: установка/обновление, обслуживание, задания
Invoke-1CMenu

# Меню задач планировщика (создание задач на регулярное сжатие ЖР и т.п.)
Invoke-1CTaskMenu
```
Меню также позволяет создать задачи автоапгрейда (current и CurrentXX).

---

## Тонкости и полезные заметки

- **Права администратора.** Установка/регистрация DLL, создание служебной учётки и службы требуют elevated‑сессии.
- **Текущий каталог (current).** Служба всегда запускается из `...\current\bin`. Параметр `-Version` влияет только на то, какой архив будет установлен и куда укажет ссылка `current`, но не меняет имя службы и путь к бинарникам.
- **Execution Policy (Windows).** Если получаете ошибки вида «скрипты запрещены» — установите политику `RemoteSigned` для пользователя (см. выше). Групповая политика может переопределить локальные настройки. 
- **Где лежит модуль.** Модули ставятся в папки из `$env:PSModulePath` — это влияет на поиск при `Import-Module`. 
- **Коды возврата.** Для MSI `3010` = успех + требуется перезагрузка; для Robocopy успешными считаются 0–7. Учитывайте это в своих скриптах/CI. 

---

## Устранение неполадок (FAQ)

**Модуль установился, но функции «не видны».**  
Выполните `Import-Module 1CMgmt` в текущей сессии. Имейте в виду: импорт действует только на текущую сессию; при открытии новой — импорт повторяется (или используйте implicit import/профиль). 

**Скрипты заблокированы политикой исполнения.**  
Запустите PowerShell от администратора и выполните:
```powershell
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
```


**Установка из сетевой папки «падает».**  
Используйте `Install-1CPlatform -SetupPath '\\server\share\…'` — модуль скопирует архив дистрибутива в папку `1Cv8.adm` на локальном диске, распакует и поставит оттуда. Проверьте коды Robocopy (0–7 = success).

**MSI вернул код 3010. Это ошибка?**  
Нет. Это «успех, требуется перезагрузка», нормальное поведение многих MSI‑пакетов. 

---

## Справочник функций

- **Install-1CPlatform** — установка/обновление платформы 1С из папки (локальной или UNC). При сетевом пути — кэширует и ставит локально.  
- **Install-1CServer** — установка сервера 1С: создание `USR1CV8`, регистрация DLL, сервис агента. Поддерживает множественные инстансы через `-PortPrefix` (15/25/35 …), выбор версии через `-Version`, а также параметр `-SetupPath` для установки/обновления платформы из конкретной папки (локальной или UNC).  
  Параметры `-PortPrefix`, `-Version`, `-SetupPath` опциональны. По умолчанию ставится последняя найденная версия на портах 15xx.
- **Start-1CServerUpgrade** — обновление сервера current/CurrentXX до последней доступной версии. Поддерживает -SetupPath для явного указания дистрибутива и -PortPrefix для перезапуска дополнительных служб.
- **New-1CCurrentPlatformLink** — символическая ссылка `current` на активную версию платформы.  
- **New-1CDistroPackage** — распаковка дистрибутива 1С в `1Cv8.adm\<версия>`.  
- **Find-1CDistroFolder** — поиск каталога с дистрибутивами.  
- **Get-1C**, **Get-1CInstalledVersion** — сводка по путям, версиям и т.д.  
- **Compress-1Clogs** — архивирование `.lgx/.lgp` и очистка старых `.zip`.  
- **Invoke-1CMenu**, **Invoke-1CMaintenanceMenu**, **Invoke-1CTaskMenu** — консольные меню для типовых операций.  
- **New-1CDefaultCompressTask**, **New-1CCustomCompressTask** — задания для планировщика на регулярное сжатие ЖР.  
- **Update-Module1CMgmt**, **New-ModuleUpdateTask** — обновление самого модуля.
- **New-1CServerAutoUpgradeTask** — создаёт задачи планировщика для nightly-апгрейда платформы (current и CurrentXX), с автогенерацией имён задач.

---
